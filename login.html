<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | EventFlow</title>
    <meta name="description" content="Login to College Event Management System">
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3176/3176396.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: var(--primary);
        }
    </style>
</head>

<body>
    <div id="auth-loader"
        style="position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted);">
        <i class="fa-solid fa-circle-notch fa-spin"
            style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
        <p>Redirecting...</p>
    </div>

    <div class="glass-panel login-card">
        <div class="login-header">
            <h1 class="logo" style="margin-bottom: 0.5rem; font-size: 2rem;">
                <i class="fa-solid fa-shapes"></i> EventFlow
            </h1>
            <p style="color: var(--text-muted)">Student & Admin Portal</p>
        </div>

        <form id="form-login">
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <div style="position: relative;">
                    <i class="fa-regular fa-envelope"
                        style="position: absolute; left: 1rem; top: 1rem; color: var(--text-muted);"></i>
                    <input type="email" name="email" class="form-control" style="padding-left: 2.5rem;" required
                        placeholder="admin@college.edu">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div style="position: relative;">
                    <i class="fa-solid fa-lock"
                        style="position: absolute; left: 1rem; top: 1rem; color: var(--text-muted);"></i>
                    <input type="password" id="password-input" name="password" class="form-control"
                        style="padding-left: 2.5rem; padding-right: 3rem;" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    <button type="button" id="toggle-password" class="password-toggle"
                        aria-label="Toggle password visibility">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                <i class="fa-solid fa-right-to-bracket"></i> Sign In
            </button>
        </form>

        <div style="text-align: center; margin: 1.5rem 0; color: var(--text-muted); font-size: 0.9rem;">OR</div>

        <button id="btn-google-signin" class="btn btn-secondary"
            style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fa-brands fa-google"></i> Continue with Google
        </button>

        <div id="error-msg"
            style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #f87171; font-size: 0.9rem;">
        </div>

        <p style="text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.85rem;">
            Don't have an account? <a href="#" id="link-forgot-password" style="color: var(--primary);">Forgot
                Password?</a>
        </p>
    </div>

    <!-- Load Utils First (Global) -->
    <script src="js/utils.js"></script>

    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { authService } from './js/auth.js';

        // Start monitoring auth state (Redirects if already logged in)
        authService.monitorAuth();

        // Utils is now global from the script tag above
        const Utils = window.Utils;
        console.log("Login Script Loaded - VERSION 5 (Fixed Imports)");

        const form = document.getElementById('form-login');
        const btnGoogle = document.getElementById('btn-google-signin');
        const errorDiv = document.getElementById('error-msg');
        const forgotLink = document.getElementById('link-forgot-password');

        // Password visibility toggle
        const togglePassword = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password-input');

        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                const icon = togglePassword.querySelector('i');
                icon.className = type === 'password' ? 'fa-regular fa-eye' : 'fa-regular fa-eye-slash';
            });
        }

        function showError(msg) {
            errorDiv.innerHTML = msg;
            errorDiv.style.display = 'block';
        }

        // Google Sign-In
        btnGoogle.addEventListener('click', async () => {
            // alert("DEBUG: Google Button Clicked!"); // UNCOMMENT IF NEEDED
            console.log("Google Button Clicked");

            errorDiv.style.display = 'none';
            try {
                if (!authService) {
                    alert("Critical Error: AuthService is missing!");
                    throw new Error("AuthService not initialized");
                }

                await authService.loginWithGoogle();

                if (Utils) Utils.showToast('Login Successful. Redirecting...', 'success');
                // MonitorAuth logic generally handles the redirect, but we can double check
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error("Google Login Error:", error);
                let msg = `Login Failed: ${error.message}`;
                if (error.code === 'auth/popup-closed-by-user') {
                    msg = 'Sign-in cancelled by user.';
                }
                showError(msg);
            }
        });

        // Email/Password Login
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = form.email.value;
            const password = form.password.value;
            const btnSubmit = form.querySelector('button[type="submit"]');

            if (errorDiv) errorDiv.style.display = 'none';
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Signing In...';

            try {
                await authService.login(email, password);
                Utils.showToast('Login Successful!', 'success');

                // Fallback: If monitorAuth doesn't redirect within 2s, force it.
                btnSubmit.innerHTML = '<i class="fa-solid fa-check"></i> Success!';
                setTimeout(() => {
                    window.location.assign('student.html');
                }, 2000);
            } catch (error) {
                console.error("Login Error:", error);
                let msg = "Login Failed: " + error.message;
                if (error.code === 'auth/invalid-credential') msg = "Invalid email or password.";
                showError(msg);
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Sign In';
            }
        });

        // Forgot Password
        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            alert('Password reset functionality coming soon! Please contact admin.');
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>

    <!-- Platform Rules Section -->
    <div class="container" style="max-width: 480px; margin-top: 2rem;">
        <div class="glass-panel" style="padding: 1.5rem;">
            <h3 style="color: var(--primary); margin-bottom: 1rem; text-align: center;">Platform Rules & Guidelines ðŸ“œ
            </h3>

            <div
                style="max-height: 200px; overflow-y: auto; font-size: 0.85rem; color: var(--text-muted); padding-right: 0.5rem;">
                <p><strong>1. Ticket Usage:</strong> QR codes are unique and valid for <strong>one-time use
                        only</strong>. Do not share screenshots.</p>
                <div style="margin: 0.5rem 0; border-top: 1px solid var(--glass-border);"></div>

                <p><strong>2. Account Security:</strong> Keep your login credentials private. You are responsible for
                    all activity on your account.</p>
                <div style="margin: 0.5rem 0; border-top: 1px solid var(--glass-border);"></div>

                <p><strong>3. Conduct:</strong> Registering implies a commitment to attend. Please respect the event
                    organizers and venue rules.</p>
            </div>
        </div>
    </div>
    <footer style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem;">
        <p>&copy; 2026 CJ Productions</p>
        <p>
            <a href="terms.html" style="color: var(--text-muted); text-decoration: underline;">Terms & Privacy</a>
        </p>
    </footer>
</body>

</html>