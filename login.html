<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | EventFlow</title>
    <meta name="description" content="Login to College Event Management System">
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3176/3176396.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: var(--primary);
        }
    </style>
</head>

<body>
    <div id="auth-loader"
        style="position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted);">
        <i class="fa-solid fa-circle-notch fa-spin"
            style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
        <p>Redirecting...</p>
    </div>

    <div class="glass-panel login-card">
        <div class="login-header">
            <h1 class="logo" style="margin-bottom: 0.5rem; font-size: 2rem;">
                <i class="fa-solid fa-shapes"></i> EventFlow
            </h1>
            <p style="color: var(--text-muted)">Student & Admin Portal</p>
        </div>

        <form id="form-login">
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <div style="position: relative;">
                    <i class="fa-regular fa-envelope"
                        style="position: absolute; left: 1rem; top: 1rem; color: var(--text-muted);"></i>
                    <input type="email" name="email" class="form-control" style="padding-left: 2.5rem;" required
                        placeholder="admin@college.edu">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div style="position: relative;">
                    <i class="fa-solid fa-lock"
                        style="position: absolute; left: 1rem; top: 1rem; color: var(--text-muted);"></i>
                    <input type="password" id="password-input" name="password" class="form-control"
                        style="padding-left: 2.5rem; padding-right: 3rem;" required placeholder="••••••••">
                    <button type="button" id="toggle-password" class="password-toggle"
                        aria-label="Toggle password visibility">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                <i class="fa-solid fa-right-to-bracket"></i> Sign In
            </button>
        </form>

        <div style="text-align: center; margin: 1.5rem 0; color: var(--text-muted); font-size: 0.9rem;">OR</div>

        <button id="btn-google-signin" class="btn btn-secondary"
            style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fa-brands fa-google"></i> Continue with Google
        </button>

        <div id="error-msg"
            style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #f87171; font-size: 0.9rem;">
        </div>

        <p style="text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.85rem;">
            Don't have an account? <a href="#" id="link-forgot-password" style="color: var(--primary);">Forgot
                Password?</a>
        </p>
    </div>

    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { authService } from './js/auth.js';
        import { Utils } from './js/utils.js';

        const form = document.getElementById('form-login');
        const btnGoogle = document.getElementById('btn-google-signin');
        const errorDiv = document.getElementById('error-msg');
        const forgotLink = document.getElementById('link-forgot-password');

        // Password visibility toggle
        const togglePassword = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password-input');

        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;

                // Toggle icon
                const icon = togglePassword.querySelector('i');
                if (type === 'password') {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            });
        }

        function showError(msg) {
            errorDiv.innerHTML = msg;
            errorDiv.style.display = 'block';
        }

        // Google Sign-In
        btnGoogle.addEventListener('click', async () => {
            errorDiv.style.display = 'none';
            try {
                await authService.loginWithGoogle();
                Utils.showToast('Login Successful. Redirecting...', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error("Google Login Error:", error);
                let msg = `Login Failed: ${error.message}`;
                if (error.code === 'auth/popup-closed-by-user') {
                    msg = 'Sign-in cancelled by user.';
                }
                showError(msg);
            }
        });

        // Email/Password Login (Demo)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            alert('This is a demo login form. Please use Google Sign-In for authentication.');
        });

        // Forgot Password
        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            alert('Password reset functionality coming soon! Please contact admin.');
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>

</html>