<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | EventFlow</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

    <!-- Auth Loader -->
    <div id="auth-loader"
        style="position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted);">
        <i class="fa-solid fa-circle-notch fa-spin"
            style="font-size: 3rem; color: var(--secondary); margin-bottom: 1rem;"></i>
        <p>Loading Student Portal...</p>
    </div>

    <!-- Navbar -->
    <nav class="navbar hidden" id="main-nav">
        <div class="container nav-container">
            <a href="#" class="logo">
                <i class="fa-solid fa-graduation-cap"></i> Student Portal
            </a>
            <div class="nav-links">
                <button id="btn-logout-student" class="btn btn-danger" title="Sign Out">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container hidden" id="main-content">

        <!-- Profile Section -->
        <div class="glass-panel mb-4" style="display: flex; align-items: center; gap: 1.5rem; padding: 2rem;">
            <div
                style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; color: white;">
                <img id="user-photo" src="" alt="Profile"
                    style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <span id="user-initials">U</span>
            </div>
            <div>
                <h2 id="user-name" style="margin-bottom: 0.25rem;">Student</h2>
                <p id="user-email" style="color: var(--text-muted); margin-bottom: 0.5rem;">Loading...</p>
                <div style="display: flex; gap: 0.5rem;">
                    <span class="badge badge-secondary">Student Account</span>
                </div>
            </div>
        </div>

        <!-- Upcoming Events Section -->
        <div class="mb-4">
            <h1>Upcoming Events</h1>
            <p style="color: var(--text-muted)">Browse and register for upcoming events.</p>
        </div>

        <div id="events-grid" class="grid grid-cols-3 mb-6">
            <!-- Events injected here -->
            <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 3;">
                <p style="color: var(--text-muted)">Loading events...</p>
            </div>
        </div>

        <!-- My Tickets Section -->
        <div class="mb-4">
            <h1>My Tickets</h1>
            <p style="color: var(--text-muted)">Events you have registered for.</p>
        </div>

        <div id="tickets-grid" class="grid grid-cols-2">
            <!-- Tickets injected here -->
            <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 2;">
                <p style="color: var(--text-muted)">Loading your tickets...</p>
            </div>
        </div>

        <!-- Platform Rules Section -->
        <div class="glass-panel mt-6" style="padding: 2rem; margin-top: 3rem;">
            <h2
                style="color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                <i class="fa-solid fa-scale-balanced" style="margin-right: 0.5rem;"></i> Platform Rules & Guidelines
            </h2>
            <div class="grid grid-cols-3" style="gap: 1.5rem;">
                <div>
                    <h3 style="font-size: 1rem; color: var(--text-light); margin-bottom: 0.5rem;">üéüÔ∏è Ticket Usage</h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        QR codes are unique to you. They can be scanned <strong>only once</strong> per event.
                        Do not share screenshots with others.
                    </p>
                </div>
                <div>
                    <h3 style="font-size: 1rem; color: var(--text-light); margin-bottom: 0.5rem;">üõ°Ô∏è Account Security
                    </h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        You are responsible for your account activity. Keep credentials safe.
                        Role abuse (if applicable) results in immediate ban.
                    </p>
                </div>
                <div>
                    <h3 style="font-size: 1rem; color: var(--text-light); margin-bottom: 0.5rem;">üéì Event Conduct</h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted);">
                        Register only if you plan to attend. Follow the college Code of Conduct at all venue locations.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script src="js/utils.js"></script>
    <script type="module">
        import { dbManager } from './js/db-firestore.js';
        import { authService } from './js/auth.js';
        import { auth } from './js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const Utils = window.Utils;

        console.log('üéì [STUDENT PORTAL] Initializing...');

        // Monitor auth state
        onAuthStateChanged(auth, async (user) => {
            console.log('üîî [STUDENT PORTAL] Auth state:', user ? user.email : 'No user');

            if (!user) {
                console.log('‚ùå [STUDENT PORTAL] No user, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            // Real-time Role Check
            dbManager.listenToUserProfile(user.uid, (profile) => {
                const role = profile.role || 'user';
                if (role === 'admin') {
                    window.location.href = 'admin.html';
                } else if (role === 'officer') {
                    window.location.href = 'officer.html';
                }
            });

            try {
                // Hide loader, show content
                document.getElementById('auth-loader').classList.add('hidden');
                document.getElementById('main-nav').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');

                console.log('‚úÖ [STUDENT PORTAL] UI visible');

                // Populate Profile
                document.getElementById('user-name').textContent = user.displayName || 'Student';
                document.getElementById('user-email').textContent = user.email;

                if (user.photoURL) {
                    const img = document.getElementById('user-photo');
                    img.src = user.photoURL;
                    img.style.display = 'block';
                    document.getElementById('user-initials').style.display = 'none';
                } else {
                    const initials = (user.displayName || user.email).charAt(0).toUpperCase();
                    document.getElementById('user-initials').textContent = initials;
                }

                // Load data
                await Promise.all([
                    loadUpcomingEvents(user),
                    loadMyTickets(user)
                ]);

                console.log('‚úÖ [STUDENT PORTAL] All data loaded');

            } catch (error) {
                console.error('‚ùå [STUDENT PORTAL] Error:', error);
                Utils.showToast('Error loading portal: ' + error.message, 'error');
            }
        });

        // Load Upcoming Events
        async function loadUpcomingEvents(user) {
            console.log('üìÖ [STUDENT PORTAL] Loading upcoming events...');
            const eventsGrid = document.getElementById('events-grid');

            try {
                const allEvents = await dbManager.getAllEvents();
                const allRegs = await dbManager.getRegistrations();

                // Get user's registered event IDs
                const myEventIds = allRegs
                    .filter(r => r.email.toLowerCase() === user.email.toLowerCase())
                    .map(r => r.eventId);

                // Filter to upcoming events only
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                const upcomingEvents = allEvents.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate >= now;
                });

                console.log(`üìä [STUDENT PORTAL] Found ${upcomingEvents.length} upcoming events`);

                eventsGrid.innerHTML = '';

                if (upcomingEvents.length === 0) {
                    eventsGrid.innerHTML = `
                        <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 3;">
                            <i class="fa-solid fa-calendar-xmark" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-muted)">No upcoming events at the moment.</p>
                        </div>
                    `;
                    return;
                }

                upcomingEvents.forEach(event => {
                    const alreadyRegistered = myEventIds.includes(event.id);

                    const card = document.createElement('div');
                    card.className = 'glass-panel';
                    card.style.padding = '1.5rem';
                    card.innerHTML = `
                        <h3 style="color: var(--primary); margin-bottom: 0.75rem;">${event.title}</h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fa-regular fa-calendar"></i> ${Utils.formatDate(event.date)}
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fa-solid fa-clock"></i> ${event.time || 'TBA'}
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fa-solid fa-location-dot"></i> ${event.venue}
                        </p>
                        ${event.capacity ? `
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                                <i class="fa-solid fa-users"></i> Capacity: ${event.capacity}
                            </p>
                        ` : ''}
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5;">
                            ${event.description || 'No description available.'}
                        </p>
                        ${alreadyRegistered ? `
                            <button class="btn btn-secondary" disabled style="width: 100%; opacity: 0.6; cursor: not-allowed;">
                                <i class="fa-solid fa-check"></i> Already Registered
                            </button>
                        ` : `
                            <a href="register.html?event=${event.id}" class="btn btn-primary" style="width: 100%; text-decoration: none; display: inline-block; text-align: center;">
                                <i class="fa-solid fa-ticket"></i> Buy Ticket
                            </a>
                        `}
                    `;
                    eventsGrid.appendChild(card);
                });

            } catch (error) {
                console.error('‚ùå [STUDENT PORTAL] Error loading events:', error);
                eventsGrid.innerHTML = `
                    <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 3;">
                        <p style="color: var(--danger)">Error loading events: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load My Tickets
        async function loadMyTickets(user) {
            console.log('üé´ [STUDENT PORTAL] Loading tickets...');
            const ticketsGrid = document.getElementById('tickets-grid');

            try {
                const allRegs = await dbManager.getRegistrations();
                const myRegs = allRegs.filter(r => r.email.toLowerCase() === user.email.toLowerCase());
                const events = await dbManager.getAllEvents();

                console.log(`üìä [STUDENT PORTAL] Found ${myRegs.length} tickets`);

                ticketsGrid.innerHTML = '';

                if (myRegs.length === 0) {
                    ticketsGrid.innerHTML = `
                        <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 2;">
                            <i class="fa-solid fa-ticket" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-muted); margin-bottom: 1rem;">No tickets yet!</p>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Browse upcoming events above to get started.</p>
                        </div>
                    `;
                    return;
                }

                myRegs.forEach(reg => {
                    const event = events.find(e => e.id === reg.eventId);
                    if (!event) return;

                    const ticketUrl = new URL(`register.html?event=${event.id}&ticket=${reg.id}`, window.location.href).href;
                    const waText = `üéâ I'm attending ${event.title}!\n\nüìÖ Date: ${Utils.formatDate(event.date)}\nüìç Venue: ${event.venue}\n\nView Ticket: ${ticketUrl}\n\nSee you there!`;

                    const card = document.createElement('div');
                    card.className = 'glass-panel';
                    card.style.padding = '1.5rem';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 style="color: var(--secondary)">${event.title}</h3>
                            <span class="badge ${reg.scanned ? 'badge-success' : 'badge-warning'}">
                                ${reg.scanned ? 'Attended' : 'Registered'}
                            </span>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fa-regular fa-calendar"></i> ${Utils.formatDate(event.date)}
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <i class="fa-solid fa-location-dot"></i> ${event.venue}
                        </p>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem; font-family: monospace;">
                            Ticket ID: ${reg.id.substring(0, 8)}...
                        </p>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="register.html?event=${event.id}&ticket=${reg.id}" target="_blank" class="btn btn-primary" style="flex: 1; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-solid fa-qrcode"></i> View
                            </a>
                            <a href="https://wa.me/?text=${encodeURIComponent(waText)}" target="_blank" class="btn btn-secondary" style="flex: 1; text-decoration: none; display: flex; align-items: center; justify-content: center; background: #25D366;">
                                <i class="fa-brands fa-whatsapp"></i> Share
                            </a>
                        </div>
                    `;
                    ticketsGrid.appendChild(card);
                });

            } catch (error) {
                console.error('‚ùå [STUDENT PORTAL] Error loading tickets:', error);
                ticketsGrid.innerHTML = `
                    <div class="glass-panel" style="padding: 2rem; text-align: center; grid-column: span 2;">
                        <p style="color: var(--danger)">Error loading tickets: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Logout Handler
        document.getElementById('btn-logout-student').addEventListener('click', async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await authService.logout();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    Utils.showToast('Logout failed', 'error');
                }
            }
        });

    </script>
</body>

</html>